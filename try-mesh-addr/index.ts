import { MeshWallet, MeshTxBuilder, Transaction, pubKeyAddress } from "@meshsdk/core";
import { serializeAddressObj, serializeRewardAddress } from "@meshsdk/core";
import { deserializeDatum, deserializeAddress } from "@meshsdk/core";
import { resolveTxHash, resolveDataHash, resolveRewardAddress, policyId, resolveFingerprint, resolveEpochNo, resolveSlotNo } from "@meshsdk/core";

import { BlockfrostProvider } from "@meshsdk/core";
import { OgmiosProvider } from "@meshsdk/core";

import { TxParser } from "@meshsdk/core";
import { CSLSerializer } from "@meshsdk/core-csl";

// cannot use this BF (ryo) to submit tx
const bfProvider = new BlockfrostProvider('http://localhost:3000');
// instead, use ogmios to submit tx
const ogmProvider = new OgmiosProvider('ws://localhost:1337');

const wallet = new MeshWallet({
  networkId: 0, // 0: testnet, 1: mainnet
  fetcher: bfProvider,
  submitter: ogmProvider,
  // key: {
  //   type: 'address',
  //   address: 'addr_test1vru2drx33ev6dt8gfq245r5k0tmy7ngqe79va69de9dxkrg09c7d3',
  // },
  // key: {
  //   type: 'cli',
  //   payment: '58204e1eaaad4ed0ab25c802b7dd90fc8e30001c88bb19dd04a0eea592050b80f35d',
  // },
  key: {
    type: 'root',
    bech32: 'xprv16qtcxhmga666e0hshgktssad3hq8zygnjpf5say24ptf8uxh9prnlnsckdml00n0kppp3e2wtqv0zv8vl7glhhkdcnxt3muytl896uczgq7h5fdamvudlkaytjcjjz4c2xltja8mgjzceqqtnkepzd8j55jva356',
  },
});

await wallet.init();

// // sleep for 1 second to ensure wallet is initialized
// await new Promise(resolve => setTimeout(resolve, 3000));

const address = await wallet.getChangeAddress();
// const address = await wallet.getUsedAddresses();
console.log('Change Address:', address);

const balance = await wallet.getBalance();
console.log('Balance:', balance);

// await provider.fetchAddressAssets('addr_test1vp5cxztpc6hep9ds7fjgmle3l225tk8ske3rmwr9adu0m6qchmx5z')
//   .then((assets) => {
//     console.log('Assets:', assets);
//   })
//   .catch((error) => {
//     console.error('Error fetching assets:', error);
//   });

// const collateralUtxos = await wallet.getCollateral();
// console.log('Collateral Utxos:', collateralUtxos);

// const rewardAddresses = wallet.getRewardAddresses();
// console.log('Reward Addresses:', rewardAddresses);

// const utxos = await wallet.getUtxos();
// console.log('Utxos:', utxos);

// const signature = await wallet.signData('mesh');
// console.log('Signature:', signature);


// const pp = await provider.fetchProtocolParameters();
const txBuilder = new MeshTxBuilder({
  fetcher: bfProvider,
  submitter: ogmProvider,
  evaluator: ogmProvider,
  // params: pp,
  verbose: true,
});

// const utxos = await wallet.getUtxos();
// const changeAddress = await wallet.getChangeAddress();

// const unsignedTx = await txBuilder
//   .txOut('addr_test1vqa25t3aayfmpad20elswmsj94ehmdfjnhc64yz3jg5yl6skf5cck', [{ unit: "lovelace", quantity: '1100000' }])
//   .changeAddress(changeAddress)
//   .selectUtxosFrom(utxos)
//   .complete();

// const signedTx = await wallet.signTx(unsignedTx);
// const txHash = await wallet.submitTx(signedTx);
// console.log('Transaction Hash:', txHash);


// ## RESOLVE
// 
// https://meshjs.dev/apis/utilities/resolvers#resolveTxHash
// 
// const tx = new Transaction({ initiator: wallet });
// tx.sendLovelace('addr_test1vpvx0sacufuypa2k4sngk7q40zc5c4npl337uusdh64kv0c7e4cxr', '1500000');
// // 
// const unsignedTx = await tx.build();
// const hash1 = resolveTxHash(unsignedTx);
// 
// const signedTx = await wallet.signTx(unsignedTx, false);
// const hash2 = resolveTxHash(signedTx);
// 
// const txHash = await wallet.submitTx(signedTx);
// 
// console.log('Unsigned Transaction Hash:', hash1);
// console.log('Signed Transaction Hash:', hash2);
// console.log('Submitted Transaction Hash:', txHash);


// // https://meshjs.dev/apis/utilities/resolvers#resolveDataHash
// 
// const datum1 = "supersecretdatum";
// const datumHash1 = resolveDataHash(datum1);
// console.log('Datum Hash 1:', datumHash1);


// https://meshjs.dev/apis/utilities/resolvers#resolveFingerprint
// 
// const policyId = '426117329844ccb3b0ba877220ff06a5bdf21eab3fb33e2f3a3f8e69';
// const assetName = '4d657368546f6b656e';
// const assetFingerprint = resolveFingerprint(
//   policyId,
//   assetName
// );
// console.log('Asset Fingerprint:', assetFingerprint);


// DESERIALIZE
// 
// https://meshjs.dev/apis/utilities/deserializers#deserializeAddress
// 
// const addressObj = deserializeAddress("addr_test1qpse7xqay7zjx8vrqkpuyxxkum70hcvz86jdxz9td5c8pxwz89h6y59fanmeweaj5wjn3gjsc5et5d4sd37dlfxlfj3swqwzjj")
// console.log('Deserialized Address:', addressObj);

// https://meshjs.dev/apis/utilities/serializers#serializeAddressObj
// 
// const paymentPubKeyAddr = pubKeyAddress(
//   addressObj.pubKeyHash,
// );
// const paymentAddr = serializeAddressObj(paymentPubKeyAddr, 0);
// console.log('Serialized Payment Address:', paymentAddr);

// https://meshjs.dev/apis/utilities/serializers#serializeRewardAddress
// 
// const stakeAddr = serializeRewardAddress(addressObj.stakeCredentialHash, false, 0);
// console.log('Serialized Stake Address:', stakeAddr);
// console.log('Resolved Stake Address:', resolveRewardAddress('addr_test1qpse7xqay7zjx8vrqkpuyxxkum70hcvz86jdxz9td5c8pxwz89h6y59fanmeweaj5wjn3gjsc5et5d4sd37dlfxlfj3swqwzjj'));

// https://meshjs.dev/apis/utilities/deserializers#deserializeDatum
// 
// const datumJSON = deserializeDatum("82018282051a05f5e0ff8200581c5867c3b8e27840f556ac268b781578b14c5661fc63ee720dbeab663f");
// console.log('Datum JSON:', datumJSON);


// // https://meshjs.dev/apis/utilities/resolvers#resolveEpochNumber
// const epoch = resolveEpochNo('preview');
// console.log('Epoch Number:', epoch);

// // https://meshjs.dev/apis/utilities/resolvers#resolveSlotNumber
// const slot = resolveSlotNo('preview');
// console.log('Slot Number:', slot);

// let oneYearFromNow = new Date();
// oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
// const epoch2 = resolveEpochNo('preview', oneYearFromNow.getTime());
// console.log('Epoch Number 1 year later:', epoch2);
// const slot2 = resolveSlotNo('preview', oneYearFromNow.getTime());
// console.log('Slot Number 1 year later:', slot2);


// https://meshjs.dev/apis/txparser/basics#initializeTxParser
const fetcher = bfProvider;
const serializer = new CSLSerializer();
const txParser = new TxParser(serializer, fetcher);

// console.log('Tx CBOR:', unsignedTx);
// const txHex = "84a400d901028182582032ca8fbb81a3372b85241819b98dd12838c55c30702f3ea451afa733825c5e5a01018282581d605867c3b8e27840f556ac268b781578b14c5661fc63ee720dbeab663f1a0016e36082583900619f181d2785231d830583c218d6e6fcfbe1823ea4d308ab6d307099c2396fa250a9ecf79767b2a3a538a250c532ba36b06c7cdfa4df4ca31a06fb2f6c021a00029335075820bdaa99eb158414dea0a91d6c727e2268574b23efe6e08ab3b841abe8059a030ca0f5d90103a0"
const txHex = "84a700d9010281825820f6517c044eb66ac5b198044e020d28151b868ab78881f143fc236888f156cb6500018182581d700a660d8c973a6a303ac95539831aaa75d336e98b7354e777ca0429208200a1581cbf8600e0e5905d434963ab99881b74fe952f2b8bdc5b64886b80c528a14c4c6f79616c7479546f6b656e183c0200075820bdaa99eb158414dea0a91d6c727e2268574b23efe6e08ab3b841abe8059a030c0b582026f307c8bfa4fcf12b5341eeeb90085cd9c159acd9cbcea03b24e23f283ce5a50dd90102818258209b322e132f35ffde77d405e85107cef908304077d09dba75d33483ce6eb56960000ed9010281581cad3da74cf9396c7f6031115f2315141db1ae43511aa757022c5e876ba400d9010281825820236ea760e98cda19ab363f1bd8453e0005f93696847c3bd56195cd1ad060874d5840dc6541ca2fb388811f2ad79eaf8011375894d6d642430321f2265bb9a312f87c83388019e4f488f77db1afaae6df0e25665fef41995f441c0f9d7f00e184730104d9010281d8799fd87980d8799f1b0000019862edac00ffd8799f581cad3da74cf9396c7f6031115f2315141db1ae43511aa757022c5e876bffd8799f581c23498ef4eb7dbfb3bd28cde66eb833468dadccb1506d7281177438a7ffd8799f581c535be38368552cf7439ee27d22daf78a72733bf59a764ea51cafa282ffff05a182000082d87b80821a006acfc01ab2d05e0007d9010281590fbe010100222229800aba2aba1aba0aab9faab9eaab9dab9a9bae0059bae0039bae002488888888896600264653001300b00198059806000cdc3a4005300b0024888966002600460166ea800e266453001301100298089809001488c966002600800315980098089baa0038014590124566002600e00315980098089baa00380145901245900f201e300f37540052232598009802000c4c8c966002602e0050048b2028375a602a00260226ea800e2b300130070018acc004c044dd5001c00a2c80922c807900f18079baa00248888cc8966002600e0031323232329800980d800cdd6980d801cdd6980d8012444b3001301f004899805980f003899805001804c5901c0c06c004c068004c064004c050dd5006456600260140031323259800980d00140122c80b8dd6980c000980a1baa00c8acc004cdc3a4008003159800980a1baa00c80145901545901220244048330012301630170019ba5480024602c602e602e00323016301730173017301700198089baa00a911919800800801912cc00400629422b30013371e6eb8c06400400e2946266004004603400280a101724444446644b3001300d004899192cc004c03cc06cdd5006c6600244b30010018a4d13259800800c5268992cc004cdc81bae301f3023003375c603e0031330040043302200130240028b203c30220014080604400280fa444b300130120018801466002007302300299b8000148005003203a91810181098109810800c88c9660026024603c6ea800626044603e6ea80062c80e8c966002602400314c103d87a80008acc004c054006264646600200200844b30010018a6103d87a8000899192cc004cdc8802800c56600266e3c014006260226604c604800497ae08a60103d87a80004089133004004302800340886eb8c088004c0940050231bae3022301f37540071300c330213022301f375400697ae0407480e8c074dd500148888c8cc0040040148966002003133024337606ea4014dd380225eb7bdb1822653001375c604400337586046003302700248896600266e4002400e26605066ec0dd48049ba70080058acc004cdc7804801c4c9660026034604c6ea800626605266ec0dd4805181518139baa0010028801204a9800804c00a010803a26605066ec0dd48019ba70023300600600140908120604a002811a603e60386ea80366603c603e0046603c603e0026603c603e604000297ae0980e1baa01148888888a60026010011300700798141814000cdd61813800cc0a0c090dd5001a4444530012225980099b880014802a26600e00400315980099b89480500063300100398181818181818181818181818181818181818180014cdc0000a4026801a33001003981818181818181818180014cdc0000a4012801902a205498169816981698169816801cdd61816001cdd718161816800a44446644653001375660666068003980098198034dd6980e18181baa303330303754071301c303037540714a280c24464b30010018b44c0d800503419802801000a444b300130263032375400513259800981398199baa001899192cc004c0b0c0d4dd5000c4c96600264b3001302e3037375400314a31337126eb4c0ecc0e0dd50039bad303b3038375400281b0c0e803e2b3001332298009bad303c001cc00400a06b0344081303c017488966002b300133710900000144cdc4801801452820748992cc004c0ccc0f0dd5000c4cdc3802001c56600266e2001000e264646644b30013037304037540031332259800981b18211baa001899191919194c004dd71825800cc12c0126eb8c12c00e6eb8c12c0092222598009828002c4cc0f0c13c0244cc0ec00c56600266ebcc13cc130dd5005008c56600266ebcc0e8c130dd5005181d18261baa02b8acc004cdc79bae3038304c37540146eb8c0e0c130dd5015c56600266e3cdd7181718261baa00a375c605c60986ea80ae2b30013375e6e9966002607e027100d8991919800800807912cc0040062660a266ec0dd48259ba60034bd6f7b63044ca60026eb8c13c0066eacc14000660a80049112cc004cdc8027801c4cc154cdd81ba904f374c00e00b15980099b8f04f0038992cc004c11cc14cdd5000c4cc158cdd81ba90503057305437540020051002414864b300159800800c528c52820aa8a6103d87a8000898209982b1ba60014bd7020a432330010010032259800800c4cc15ccdd81ba9050375003897adef6c608994c004dd7182a800cdd6982b000cc1680092225980099b9005400389982d99bb037520a86ea00800162b30013371e0a8007132598009826982c9baa00189982e19bb037520aa60ba60b46ea800400a200482c0c966002609a00314c103d87a8000898239982e1ba80014bd7020b03370000404113305b337606ea400cdd400119803003000a0ae415c30580014159133055337606ea400cdd300119803003000a0a2414430520014140646400460520026609c66ec0dd48239ba80134bd6f7b6302094374c02b13371e01602d14a08252294104a452820948a50412914a082522c8268609600260940026092002609000260866ea80062c8208dd7182218209baa00133022304430450030118b207e375660840026084607e6ea8c108008c108004c0f4dd5198058091bad3040303d37540031640ec81d8c0fcc1000122c81d06eacc0e8c0ec00cc0ec0562b300198009bab303a00891118139981e1ba73303c375066e00dd6981e8011bad303d0013303c375066e00dd698140011bad30280014bd7025eb82444b30010028800c4ca6002009303f00399194c004c1040066080607a6ea8c1000066eb0c0f400d22259800981b181f9baa0028acc004cdc79bae30433040375400407b13259800981a18201baa001899191919194c004dd71824800cdd71824802cdd718248024dd69824801cdd69824801244444b3001304f006899912cc0056600266e1cdd6981798269baa00d0018acc004cdc39bad3039304d375401a00515980099b8f375c6070609a6ea8034086266ebcc140040dd3192cc004c104006297adef6c608991919800800a5eb7bdb1808966002003133053337606ea4134dd3001a5eb7bdb1822653001375c60a2003375660a4003305600248896600266e4014400e2660ae66ec0dd48289ba60070058acc004cdc7828801c4cc15ccdd81ba9051374c00e003133057337606ea400cdd300119803003000a0a6414c30540014148646600200297adef6c602259800800c4cc148cdd81ba904b375000697adef6c608994c004dd71828000cdd69828800cc1540092225980099b9004f00389982b19bb0375209e6ea001c0162b30013371e09e007133056337606ea413cdd4003800c4cc158cdd81ba900337500046600c00c00282910520c14c00505120983370000200514a0825a294104b45282096880a45904b1bad304e00c375a609c609e0191641303049001304800130470013046001304137540031640fc66042608660880060211640f91640f8303c37546601402266f29288009bae303a0014010607a00481d92229800800cca6002003014a5eb7bdb1810011112cc00400a200319800801cc10400a6464b30013035303e3754003159800cc004cdc79bae3042303f37540020134a14a281ea2007132598009819981f9baa0018992cc004c0d0c100dd5000c4c8c8c8ca60026090003375a6090007375a60900049112cc004c130012264660720022660700082b3001303c3048375400319800806e60029469003400d792998259ba80023304b4c010100004bd70404502946600201b9800a51a400d0035e4a660969810100003304b375000497ae0808a052411c609600f164124304800130470013046001304137540031640fc608660806ea80062c81f0c8c8cc004004028896600200314c0103d87a80008992cc004cdd78021821000c4c0c0cc114c10c0052f5c113300300330470024104608a0028218cdd2a400466082608400497ae040f5100340f46082607c6ea8c104c0f8dd518209821000981e9baa3040002400c81f294500122660406eb0c0e802402e29410354528206a8a5040d46eb8c0e4c0d8dd5000c59034181c181a9baa303800130343754606e607060686ea8c0dcc0d0dd5000c590321919800800806912cc0040062980103d87a80008992cc004cdd7981c981b1baa001028898119981c000a5eb82266006006607400481a0c0e00050364590310c0cc004c010010c0c400c45901a180f980f800980d1baa0128acc004cdc3a40080091598009806980c9baa00b89919912cc004c040c070dd5001456600264b30013014301d375400314a31337126eb4c084c078dd50019bad3021301e375400280e0c08000626600c6eb0c080c08400cdd718101810800c52820368b20369800980f000cdd69803980d9baa301e301b37540473007301b37540474a28018c07cc06cdd5180f180d9baa00c301e301e301e301e301e301e301e301a375401f1640611598009806980c9baa00b89919912cc004c040c070dd5001456600264b30013014301d375400314a11337106eb4c084c078dd50009bad3021301e375400680e0c080c084c074dd5000c4c8cc88cc008008004896600200314a3132332259800cc004c05a60026eacc098c09c00a03f01e40294a14a2810a2b30013375e604c60466ea8c098008c040cc094dd480325eb8226600a00a003164085133005005001408460426ea8004c094008c08c0050211bac3021004375c6010603a6ea8006294101b45901b4c004c078c07cc07cc07cc07cc07c0066eb4c01cc06cdd5180f180d9baa0239803980d9baa023a51400c603c60366ea8030c078c078c068dd5007c5901820304060444464b30013010301c37540031300a3301f302037586040603a6ea80052f5c113374a90011980f9ba937306e64dd71810180e9baa0014bd70203632598009809980e1baa00189991192cc0056600266e2120000038acc004cdc4801800c4cdc499b810010030028a50407914a080f22601a660446e9ccc088dd4001998111ba80014bd7025eb822980114d87a9f4f74782074696d6520696e76616c6964ff00407864b30013016301f37540031375a604660406ea80062b30010058a400113370000600480f101e1811180f9baa300d301f375400e6eb4c080c074dd500099b82598009808180e1baa00389bad3020301d37540071483a00901b00245300114d87a9f4f74782074696d65206e6f7420736574ff00406c603e60386ea8c07cc070dd5002111192cc004c048c06cdd5000c5200089bad301f301c375400280d0c966002602460366ea80062980103d87a8000899198008009bab3020301d375400444b30010018a6103d87a8000899192cc004cdc8803000c56600266e3c0180062601a66044604000497ae08a60103d87a80004079133004004302400340786eb8c078004c08400501f203432330010010042259800800c5300103d87a8000899192cc004cdc8803000c56600266e3c0180062601866042603e00497ae08a60103d87a80004075133004004302300340746eb8c074004c08000501e0c044dd50050c030dd50019b87480022c80506016002600c6ea802e29344d95900401f5d90103a0"

// https://meshjs.dev/apis/txparser/basics#rebuildTx
const txBuilderBody = await txParser.parse(txHex, []);
console.log('Parsed Transaction Body:', txBuilderBody);

// const txBuilder2 = new MeshTxBuilder({
//   fetcher: bfProvider,
//   submitter: ogmProvider,
//   evaluator: ogmProvider,
//   // params: pp,
//   verbose: true,
// });

// const x = txBuilder2.meshTxBuilderBody(txBuilderBody);
// console.log('Rebuilt Transaction:', x);
